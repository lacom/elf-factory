#!/usr/bin/env node

var program = require('commander');
var fs = require('fs');
var exec = require('child_process').exec;
var open = require('open');
var request = require('request');
var util = require('../lib/utilities.js');

var SITE_URL = config.SITE_URL;
var SITE_DOMAIN = config.SITE_DOMAIN;


// Parse the command for args and flags
program
  .option('-e, --environment <type>', 'Used to determine source file locations for interaction.')
  .parse(process.argv);

// Get the submitted interaction name
if (program.args.length > 0) {
  var name = program.args[0];
} else {
  console.log('You need to supply a name for your interaction. Type "elf" for help.');
  util.exit(1);
}

//Slufigy the interaction name to be URL friendly.
interactionName = util.slugify(name);

//Environment flag ternary; development flag should source interaciton name from local host
var env = program.environment ? program.environment : '';

openURL(interactionName, env)

function openURL(interactionSlug, env){

  var siteUrl = (env == 'development') ? 'http://localhost:3000' : SITE_URL;
  var siteDomain = (env == 'development') ? 'localhost:3000' : SITE_DOMAIN;
  var auth = netrc(siteDomain);

  if(env){
    console.log("Please upload your interaction to see the correctly rendered web page.")
  }

  request.get(siteUrl + '/api/v1/i/' + interactionSlug,  auth: {
     'user': auth.login,
     'pass':  auth.password,
     'sendImmediately': trueor
    }, 
    function(error, response, body){
    	if(error){
    		console.log("No interaction found! Error");
    		util.exit(1);
    	}
    	if(body == 'Unauthorized') {
    		console.log('Please add your auth credentials to your .netrc file first.');
  	util.exit(1);
    	}else if(body == !'success'){
    		console.log(body);
    		util.exit(1);
    	}else{
    		console.log(response.message);
    		open(SITE_URL + '/api/v1/i/' + interactionSlug);
    	}
  });
}